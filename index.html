<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="FM Characterization Fact Label">
    <title>FM Fact Label</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/d0a6ca53ae.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">

    <!-- Custom styles -->
    <link href="css/sb_admin_2/sb-admin-2.min.css" rel="stylesheet">

    <!-- d3.js -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="js/fm_fact_label/fm_fact_label.js"></script>

    <!-- FileSaver, PDFKit -->
    <script src="js/FileSaver.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfkit@0.10.0/js/pdfkit.standalone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ETY3FZE13S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-ETY3FZE13S'); 
    </script>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">FM Characterization Fact Label</h1>
                    </div>

                    <!-- Content Row -->

                    <div class="row">

                        <div class="col-xl-6 col-lg-5">
                            <div class="card shadow mb-4">

                                <ul class="nav nav-tabs" id="myTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active"
                                            id="uploadfm-tab" data-bs-toggle="tab" data-bs-target="#uploadfm"
                                            type="button" role="tab" aria-controls="uploadfm" >Upload FM</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link"
                                            id="uploadjson-tab" data-bs-toggle="tab" data-bs-target="#uploadjson"
                                            type="button" role="tab" aria-controls="uploadjson" >Upload
                                            JSON</button>
                                    </li>

                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="about-tab" data-bs-toggle="tab"
                                            data-bs-target="#about" type="button" role="tab" aria-controls="about"
                                            aria-selected="false">About</button>
                                    </li>

                                </ul>
                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade show active" id="uploadfm" role="tabpanel"
                                        aria-labelledby="uploadfm-tab">
                                        <!-- Card Header - Dropdown -->
                                        <div
                                            class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                            <h6 class="m-0 font-weight-bold text-primary">Upload your feature model</h6>
                                        </div>
                                        <!-- Card Body -->
                                        <div class="card-body">
                                            <!-- Form -->
                                            <form id="fmForm">
                                                <div class="mb-3">
                                                    <label for="inputName" class="form-label">Name</label>
                                                    <input type="text" class="form-control" id="inputName"
                                                        name="inputName" placeholder="Feature model's name">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="inputDescription" class="form-label">Description</label>
                                                    <textarea class="form-control" id="inputDescription"
                                                        name="inputDescription" rows="3"
                                                        placeholder="Brief description"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="inputAuthor" class="form-label">Author</label>
                                                    <input type="text" class="form-control" id="inputAuthor"
                                                        name="inputAuthor">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="inputYear" class="form-label">Year</label>
                                                    <input type="number" class="form-control" id="inputYear"
                                                        name="inputYear">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="inputFM" class="form-label">FM File</label>
                                                    <input type="file" class="form-control" id="inputFM" name="inputFM">
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="on"
                                                        id="lightFactLabel" name="lightFactLabel">
                                                    <label class="form-check-label" for="lightFactLabel"
                                                        data-toggle="tooltip" data-placement="top"
                                                        title="Exclude some analytical metrics (i.e., no BDD analysis)">
                                                        Light fact label
                                                    </label>
                                                </div>
                                                <button type="submit" id="submitButton"
                                                    class="btn btn-primary">Submit</button>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="uploadjson" role="tabpanel"
                                        aria-labelledby="uploadjson-tab">
                                        <!-- Form component -->

                                        <!-- Card Header - Dropdown -->
                                        <div
                                            class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                            <h6 class="m-0 font-weight-bold text-primary">Upload your characterization
                                                in JSON</h6>
                                        </div>
                                        <!-- Card Body -->
                                        <div class="card-body">
                                            <!-- Form -->
                                            <form id="jsonForm">
                                                <div class="form-group row">
                                                    <label for="inputFM" class="col-sm-2 col-form-label">JSON
                                                        file</label>
                                                    <div class="col-sm">
                                                        <input type="file" class="form-control-file" id="inputJSON"
                                                            name="inputJSON">
                                                        Supported formats: JSON (.json)
                                                    </div>
                                                </div>
                                                <button type="submit" id="submitButton"
                                                    class="spinner-button btn btn-primary">Submit</button> <i
                                                    class="fa-solid fa-circle-info" data-toggle="tooltip"
                                                    data-placement="top"
                                                    title="We value your privacy: this service does not store any personal data or models. Only your IP location is collected for statistical purposes. By submitting the form, you consent to this. For more information, please visit the About page."></i>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="about" role="tabpanel" aria-labelledby="about-tab">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Current version: {{g.version}}</h5>
                                                <p class="card-text">See <a
                                                        href="https://github.com/jmhorcas/fm_characterization/blob/main/CHANGELOG.md"><b>changelog</b></a>.
                                                </p>
                                            </div>
                                        </div>

                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">How to cite</h5>
                                                <p class="card-text">José Miguel Horcas, José A. Galindo, Lidia Fuentes,
                                                    David Benavides. <em>FM Fact Label</em>. <b>Science of Computer
                                                        Programming (SCP)</b>. 2025. DOI: <a
                                                        href="https://doi.org/10.1016/j.scico.2024.103214">https://doi.org/10.1016/j.scico.2024.103214</a>
                                                </p>
                                                <button type="button" class="btn btn-outline-primary"
                                                    onclick="copyBibTeX()">Copy BibTex</button>
                                            </div>
                                        </div>

                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Contact</h5>
                                                <p class="card-text"><a
                                                        href="https://sites.google.com/view/josemiguelhorcas">José
                                                        Miguel Horcas</a></p>
                                                <a href="mailto:&#104;&#111;&#114;&#099;&#097;&#115;&#064;&#117;&#109;&#097;&#046;&#101;&#115;?subject=[FM Fact Label]"
                                                    class="btn btn-outline-primary" role="button"
                                                    aria-pressed="true">Contact</a>
                                            </div>
                                        </div>

                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">More info</h5>
                                                <p class="card-text">Visit the official website of <a
                                                        href="https://fmfactlabel.github.io/"><b>FM Fact Label</b></a>.
                                                </p>
                                            </div>
                                        </div>

                                        <script>
                                            // Store the BibTeX entry in a JavaScript variable
                                            const bibtexEntry = `
                                      @article{Horcas2025_FMFactLabel,
                                        author       = {Jos{\'{e}} Miguel Horcas and Jos{\'{e}} A. Galindo and Lidia Fuentes and David Benavides},
                                        title        = {{FM} fact label},
                                        journal      = {Sci. Comput. Program.},
                                        volume       = {240},
                                        pages        = {103214},
                                        year         = {2025},
                                        url          = {https://doi.org/10.1016/j.scico.2024.103214},
                                        doi          = {10.1016/J.SCICO.2024.103214},
                                        timestamp    = {Mon, 21 Oct 2024 11:11:55 +0200},
                                        biburl       = {https://dblp.org/rec/journals/scp/HorcasGFB25.bib},
                                        bibsource    = {dblp computer science bibliography, https://dblp.org}
                                      }`;

                                            function copyBibTeX() {
                                                // Create a temporary textarea to hold the BibTeX entry
                                                const tempTextarea = document.createElement("textarea");
                                                tempTextarea.value = bibtexEntry;
                                                document.body.appendChild(tempTextarea);

                                                // Select and copy the text
                                                tempTextarea.select();
                                                document.execCommand("copy");

                                                // Remove the temporary textarea
                                                document.body.removeChild(tempTextarea);
                                            }
                                        </script>

                                        <script type="text/javascript">

                                            function chart_countries() {
                                                var ctx = document.getElementById('chart_countries');

                                                data = '{{data["usage_stats"]["countries"] | tojson | safe}}';
                                                data = JSON.parse(data);
                                                var x = Object.keys(data);
                                                var y = Object.values(data);

                                                new Chart(ctx, {
                                                    type: 'bar',
                                                    data: {
                                                        labels: x,
                                                        datasets: [{
                                                            label: 'Countries',
                                                            data: y,
                                                            //borderWidth: 1,
                                                            //borderColor: 'black',
                                                        }]
                                                    },
                                                    options: {
                                                        scales: {
                                                            y: {
                                                                beginAtZero: true,
                                                                title: {
                                                                    display: true,
                                                                    text: "Fact Labels generated"
                                                                },
                                                                ticks: {
                                                                    callback: function (value) {
                                                                        return Number.isInteger(value) ? value : null; // Mostrar solo enteros
                                                                    }
                                                                }
                                                            },
                                                            x: {
                                                                title: {
                                                                    display: true,
                                                                    text: "Countries"
                                                                },
                                                            }
                                                        },
                                                        //barThickness: 4,
                                                        plugins: {
                                                            legend: {
                                                                display: false
                                                            },
                                                            tooltip: {
                                                                displayColors: false,
                                                                callbacks: {
                                                                    label: function (context) {
                                                                        return context.parsed.y;
                                                                    },
                                                                }
                                                            }
                                                        }
                                                    }
                                                });
                                            }
                                            chart_countries();
                                        </script>

                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- FM Fact Label chart -->
                        <div class="col-xl-6 col-lg-7">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">FM Fact Label</h6>
                                    <div class="dropdown no-arrow">
                                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                                            aria-labelledby="dropdownMenuLink">
                                            <div class="dropdown-header">Save as...</div>
                                            <a class="dropdown-item" id="saveSVG" href="#">SVG</a>
                                            <a class="dropdown-item" id="savePNG" href="#">PNG</a>
                                            <a class="dropdown-item" id="savePDF" href="#">PDF</a>
                                            <!-- <a class="dropdown-item" id="savePDF" href="#">PDF</a> -->
                                            <div class="dropdown-divider"></div>
                                            <div class="dropdown-header">Export to...</div>
                                            <a class="dropdown-item" id="saveJSON" href="#">JSON</a>
                                            <a class="dropdown-item" id="saveTXT" href="#">Plain text</a>
                                        </div>
                                    </div>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body">
                                    <h6 class="h6">Label configuration:</h6>
                                    <div class="mt-0 small">
                                        <!-- <div class="form-check form-switch row">
                                            <span class="me-2">
                                                <input class="form-check-input" type="checkbox" id="portraitOrientation">
                                                <label class="form-check-label" for="portraitOrientation">Portrait orientation</label>
                                            </span>
                                            <span class="me-2">
                                                <input class="form-check-input" type="checkbox" id="intermediateRules">
                                                <label class="form-check-label" for="intermediateRules">Intermediate rules</label>
                                            </span>
                                        </div> -->
                                        <div class="form-check form-switch">
                                            <span class="me-2">
                                                <input class="form-check-input" type="checkbox"
                                                    id="collapseSubProperties" checked>
                                                <label class="form-check-label"
                                                    for="collapseSubProperties">Collapse/Expand sub-properties</label>
                                            </span>
                                        </div>
                                        <div class="form-check form-switch">
                                            <span class="me-2">
                                                <input class="form-check-input" type="checkbox" id="collapseZeroValues">
                                                <label class="form-check-label" for="collapseZeroValues">Collapse/Expand
                                                    sub-properties with zero values</label>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body">
                                    <svg class="chart" id="FMFactLabelChart"></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; 2024</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JQuery + Easing -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts -->
    <script src="js/sb_admin_2/sb-admin-2.min.js"></script>
    <script src="js/fm_fact_label/fm_fact_label.js"></script>
    <script src="js/fm_fact_label/fm_persistence.js"></script>

    <!-- Tooltip Initialization -->
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });
    </script>

    <!-- Pyodide Integration and drawFMFactLabel Usage -->
    <script type="text/javascript">
        let pyodide;

        async function loadPyodideAndPackages() {
            pyodideInstance = await loadPyodide();
            console.log("Pyodide loaded");
            await pyodideInstance.loadPackage("micropip");
            await pyodideInstance.loadPackage("python-sat");
            await pyodideInstance.runPythonAsync(`
  import micropip
  await micropip.install("flamapy/uvlparser-2.0.1-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/afmparser-1.0.3-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/antlr4_python3_runtime-4.13.1-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/flamapy-2.0.1-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/flamapy_fw-2.0.2.dev0-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/flamapy_fm-2.0.2.dev0-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/flamapy_sat-2.0.1-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/flamapy_bdd-2.0.1-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/dd-0.5.7-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/astutils-0.0.6-py3-none-any.whl", deps=False)
  await micropip.install("flamapy/ply-3.10-py2.py3-none-any.whl", deps=False)
  
  await micropip.install("flamapy/fact_label_json_gen-1.0.0-py3-none-any.whl", deps=False)

  `);
        }

        loadPyodideAndPackages();

        document.getElementById("fmForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            document.getElementById("submitButton").innerHTML = '<i class="fa fa-circle-o-notch fa-spin"></i> Loading...';

            const formData = new FormData(event.target);
            const formObject = {};
            formData.forEach((value, key) => { formObject[key] = value });

            const fileInputElement = document.getElementById("inputFM");
            if (!fileInputElement || fileInputElement.files.length === 0) return;
            const inputFM = fileInputElement.files[0];

            if (!inputFM) return;
            // Leer el archivo como ArrayBuffer
            const arrayBuffer = await inputFM.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            // Escribirlo en el FS de Pyodide
            pyodideInstance.FS.writeFile(inputFM.name, uint8Array);

            const pyCode = `
name = """${formObject.inputName}"""
description = """${formObject.inputDescription}"""
authors = """${formObject.inputAuthor}"""
year = int(${formObject.inputYear || 0})
domain = """${formObject.inputDomain}"""
tags = """${formObject.inputTags}"""
doi = """${formObject.inputDoi}"""

fm_file = """${inputFM.name}"""

from flamapy.metamodels.fm_metamodel.models import FeatureModel
from flamapy.metamodels.fm_metamodel.transformations import UVLReader, FeatureIDEReader

from fm_characterization import FMCharacterization
from typing import Optional


def read_fm_file(filename: str) -> Optional[FeatureModel]:
    try:
        if filename.endswith(".uvl"):
            return UVLReader(filename).transform()
        elif filename.endswith(".xml") or filename.endswith(".fide"):
            return FeatureIDEReader(filename).transform()
    except Exception as e:
        print(e)
        pass
    try:
        return UVLReader(filename).transform()
    except Exception as e:
        print(e)
        pass
    try:
        return FeatureIDEReader(filename).transform()
    except Exception as e:
        print(e)
        pass
    return None

fm = read_fm_file(fm_file)
if fm is None:
    raise Exception('Feature model format not supported.')

characterization = FMCharacterization(fm)
characterization.metadata.name = name
characterization.metadata.description = description
characterization.metadata.author = authors
characterization.metadata.year = year
characterization.metadata.tags = tags
characterization.metadata.reference = doi
characterization.metadata.domains = domain

characterization.to_json_file("fm_characterization.json")


        `;

            try {
                const resultJson = await pyodideInstance.runPythonAsync(pyCode);
                const jsonString = pyodideInstance.FS.readFile("fm_characterization.json", { encoding: "utf8" });
                const fmData = JSON.parse(jsonString);

                // Call your existing JS function with the result
                drawFMFactLabel(fmData);

            } catch (error) {
                console.error("Pyodide Error:", error);
                document.getElementById("result").innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
            }

            document.getElementById("submitButton").innerHTML = 'Submit';
        });
    </script>

    <!-- Modal (preserved from your original code) -->
    <div class="modal fade" id="metricModal" tabindex="-1" aria-labelledby="metricModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 style="color:#2e59d9" id="metricModalLabel">Metric Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-break">
                    <!-- Modal content will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="copyButton">Copy</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>